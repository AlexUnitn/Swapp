<!doctype html>
<html lang="it">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="stylesheet" href="styles.css" />
	<title>Scelta oggetti — Cards</title>
</head>
<body>
	<div class="top-left-back">
		<a href="../main/index.html" class="home-btn">← Home</a>
	</div>
  <div class="top" role="region" aria-label="Barra di ricerca stile">
    <div class="search-like" aria-hidden="false">
      <!-- search icon -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 21L16.65 16.65" stroke="#344154" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="11" cy="11" r="6" stroke="#344154" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <input type="text" placeholder="Cerca oggetti..." aria-label="Cerca oggetti" />
    </div>
    <button class="filter-btn" aria-label="Filtri">Filtri</button>
  </div>

  <main class="container" role="main" aria-label="Elenco oggetti">
    <!-- Contenitore unico per i risultati dinamici -->
    <div id="results-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; width: 100%;">
        <p>Caricamento risultati...</p>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const resultsContainer = document.getElementById('results-grid');
        const searchInput = document.querySelector('input[type="text"]');
        
        // 1. Leggi la query dall'URL
        const params = new URLSearchParams(window.location.search);
        const query = params.get('q');
        
        // Imposta il valore nell'input se presente
        if (query) searchInput.value = query;

        // 2. Chiama il Backend
        const apiUrl = query 
            ? `http://localhost:3000/api/item?search=${encodeURIComponent(query)}`
            : `http://localhost:3000/api/item`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Errore nel caricamento');
            const items = await response.json();
            
            renderItems(items);
        } catch (error) {
            console.error(error);
            resultsContainer.innerHTML = '<p style="padding:20px">Si è verificato un errore nel caricamento degli oggetti.</p>';
        }

        // Funzione per creare le card HTML
        function renderItems(items) {
            resultsContainer.innerHTML = ''; // Pulisci il caricamento

            if (items.length === 0) {
                resultsContainer.innerHTML = '<p style="padding:20px">Nessun oggetto trovato.</p>';
                return;
            }

            items.forEach(item => {
                // Crea l'elemento card
                const card = document.createElement('article');
                card.className = 'card';
                
                // Determina lo stato e il colore
                const isAvailable = item.status === 'available';
                const statusColor = isAvailable ? 'green' : 'red';
                const statusText = isAvailable ? 'Prenotabile' : 'Non prenotabile';
                
                // Immagine placeholder o reale se presente
                const imageSrc = (item.images && item.images.length > 0) 
                    ? item.images[0] // Assumiamo sia un URL o base64
                    : `https://placehold.co/400x300?text=${encodeURIComponent(item.title)}`;

                card.innerHTML = `
                    <div class="thumb">
                        <img src="${imageSrc}" alt="${item.title}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">
                    </div>
                    <div class="card-body">
                        <div style="display:flex;align-items:center;gap:12px; justify-content:space-between;">
                            <div class="title">${item.title}</div>
                            <div class="availability" title="${statusText}">
                                <span class="dot ${statusColor}"></span>
                                <span class="avail-text">${statusText}</span>
                            </div>
                        </div>

                        <div class="meta">
                            <div class="distance">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                                    <path d="M12 11.5a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" stroke="#4b5563" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 11.5c0 6.5-7 10.5-7 10.5S5 18 5 11.5a7 7 0 1 1 14 0z" stroke="#4b5563" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>${item.location?.city || 'N/A'}</span>
                            </div>
                            <div class="subtitle">${item.category || 'Generico'}</div>
                        </div>
                        <p style="font-size:0.9rem; color:#666; margin-top:8px;">${item.description}</p>
                    </div>
                `;
                
                resultsContainer.appendChild(card);
            });
        }
    });
  </script>

</body>
</html>
