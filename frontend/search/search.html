<!doctype html>
<html lang="it">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="stylesheet" href="styles.css" />
	<title>Scelta oggetti — Cards</title>
</head>
<body>
	<div class="top-left-back">
		<a href="../main/index.html" class="home-btn">← Home</a>
	</div>
  <div class="top" role="region" aria-label="Barra di ricerca stile">
    <div class="search-like" aria-hidden="false">
      <!-- search icon -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 21L16.65 16.65" stroke="#344154" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="11" cy="11" r="6" stroke="#344154" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <input type="text" placeholder="Cerca oggetti..." aria-label="Cerca oggetti" />
    </div>
    <div style="position:relative;">
        <button id="filterBtn" class="filter-btn" aria-label="Filtri">Filtri</button>
        <div id="filterDropdown" class="filter-dropdown hidden">
            <div class="filter-item" data-value="">Tutte le categorie</div>
            <div class="filter-item" data-value="electronics">Elettronica</div>
            <div class="filter-item" data-value="clothing">Abbigliamento</div>
            <div class="filter-item" data-value="books">Libri</div>
            <div class="filter-item" data-value="home">Casa e Giardino</div>
        </div>
    </div>
  </div>

  <main class="container" role="main" aria-label="Elenco oggetti">
    <!-- Contenitore unico per i risultati dinamici -->
    <div id="results-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;">
        <p>Caricamento risultati...</p>
    </div>
    
    <!-- Paginazione -->
    <div id="pagination" class="pagination-container" style="display:none; margin-top:30px; justify-content:center; gap:10px;">
        <button id="prevBtn" class="page-btn">← Precedente</button>
        <span id="pageInfo" style="display:flex; align-items:center; font-weight:600;">Pagina 1</span>
        <button id="nextBtn" class="page-btn">Successiva →</button>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const resultsContainer = document.getElementById('results-grid');
        const searchInput = document.querySelector('input[type="text"]');
        const filterBtn = document.getElementById('filterBtn');
        const filterDropdown = document.getElementById('filterDropdown');
        
        // Toggle dropdown
        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            filterDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
                filterDropdown.classList.add('hidden');
            }
        });

        // Handle category selection
        document.querySelectorAll('.filter-item').forEach(item => {
            item.addEventListener('click', () => {
                const category = item.dataset.value;
                const currentParams = new URLSearchParams(window.location.search);
                
                if (category) {
                    currentParams.set('cat', category);
                } else {
                    currentParams.delete('cat');
                }
                
                window.location.search = currentParams.toString();
            });
        });
        
        // Leggi la query dall'URL
        const params = new URLSearchParams(window.location.search);
        const query = params.get('q') || params.get('search');
        const category = params.get('cat') || params.get('category');
        
        // Imposta il valore nell'input se presente
        if (query) searchInput.value = query;

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const val = searchInput.value.trim();
                const currentParams = new URLSearchParams(window.location.search);
                
                if (val) {
                    currentParams.set('q', val);
                } else {
                    currentParams.delete('q');
                }
                
                window.location.search = currentParams.toString();
            }
        });

        // 2. Chiama il Backend
        const apiParams = new URLSearchParams();
        if (query) apiParams.set('search', query);
        if (category) apiParams.set('category', category);
        
        // Paginazione
        const currentPage = parseInt(params.get('page')) || 1;
        const limit = 8; // oggetti per pagina
        
        const apiUrl = `/api/item?${apiParams.toString()}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Errore nel caricamento');
            const allItems = await response.json();
            
            // Calcola paginazione
            const totalItems = allItems.length;
            const totalPages = Math.ceil(totalItems / limit);
            const startIndex = (currentPage - 1) * limit;
            const endIndex = startIndex + limit;
            const itemsToShow = allItems.slice(startIndex, endIndex);
            
            renderItems(itemsToShow);
            setupPagination(currentPage, totalPages);
            
        } catch (error) {
            console.error(error);
            resultsContainer.innerHTML = '<p style="padding:20px">Si è verificato un errore nel caricamento degli oggetti. Assicurati che il server sia attivo.</p>';
        }

        function setupPagination(current, total) {
            const paginationDiv = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            if (total <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            pageInfo.textContent = `Pagina ${current} di ${total}`;
            
            prevBtn.disabled = current === 1;
            nextBtn.disabled = current === total;
            
            prevBtn.onclick = () => changePage(current - 1);
            nextBtn.onclick = () => changePage(current + 1);
            
            function changePage(newPage) {
                if (newPage < 1 || newPage > total) return;
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.set('page', newPage);
                window.location.search = currentParams.toString();
            }
        }


        // Funzione per creare le card HTML
        function renderItems(items) {
            resultsContainer.innerHTML = ''; // Pulisci il caricamento

            if (items.length === 0) {
                resultsContainer.innerHTML = '<p style="padding:20px">Nessun oggetto trovato.</p>';
                return;
            }

            items.forEach(item => {
                // Crea l'elemento card
                const card = document.createElement('article');
                card.className = 'card';
                
                // Determina lo stato e il colore
                const isAvailable = item.status === 'available';
                const statusColor = isAvailable ? 'green' : 'red';
                const statusText = isAvailable ? 'Prenotabile' : 'Non prenotabile';
                
                // Immagine placeholder o reale se presente
                // Se item.images[0] esiste ed è base64 o url usalo, altrimenti placeholder
                const imageSrc = (item.images && item.images.length > 0 && item.images[0].data) 
                    ? item.images[0].data 
                    : `https://placehold.co/400x300?text=${encodeURIComponent(item.title)}`;

                card.innerHTML = `
                    <div class="thumb">
                        <img src="${imageSrc}" alt="${item.title}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">
                    </div>
                    <div class="card-body">
                        <div style="display:flex;align-items:center;gap:12px; justify-content:space-between;">
                            <div class="title">${item.title}</div>
                            <div class="availability" title="${statusText}">
                                <span class="dot ${statusColor}"></span>
                                <span class="avail-text">${statusText}</span>
                            </div>
                        </div>

                        <div class="meta">
                            <div class="distance">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                                    <path d="M12 11.5a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" stroke="#4b5563" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 11.5c0 6.5-7 10.5-7 10.5S5 18 5 11.5a7 7 0 1 1 14 0z" stroke="#4b5563" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>${item.location?.city || 'N/A'}</span>
                            </div>
                            <div class="subtitle">${item.category || 'Generico'}</div>
                        </div>
                        <p style="font-size:0.9rem; color:#666; margin-top:8px;">${item.description ? item.description.substring(0, 100) + '...' : ''}</p>
                    </div>
                `;
                
                resultsContainer.appendChild(card);
            });
        }
    });
  </script>
</body>
</html>
